<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SQUIRREL DOOM: HARDCORE EDITION</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Roboto:wght@900&family=Press+Start+2P&display=swap');
        body { margin: 0; overflow: hidden; background: #000; cursor: crosshair; user-select: none; font-family: 'Orbitron', sans-serif; touch-action: none; }
        canvas { position: absolute; top: 0; left: 0; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: space-between; transition: 0.5s; opacity: 0; }
        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
        
        /* BOTTOM HUD FOR SKILLS */
        .hud-bottom { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 20px; pointer-events: auto; }
        .skill-btn { width: 40vw; height: 50px; background: rgba(0,0,0,0.6); border: 2px solid #fff; border-radius: 10px; position: relative; overflow: hidden; pointer-events: auto; touch-action: manipulation; transition: transform 0.1s; }
        .skill-btn:active { transform: scale(0.95); }
        
        /* FIXED: Force width 100% for bars inside buttons to override old top-bar styles */
        .skill-btn .bar-fill { position: absolute; bottom: 0; left: 0; width: 100% !important; height: 0%; opacity: 0.6; z-index: 1; transition: height 0.1s; }
        
        .skill-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 14px; font-weight: bold; z-index: 2; text-shadow: 1px 1px 0 #000; width: 100%; text-align: center;}
        
        /* Specific colors for vertical bars */
        #gren-fill { background: #f80; } 
        #ult-fill { background: linear-gradient(0deg, #f0f, #a0f); }

        .bar-wrap { width: 40vw; height: 15px; background: rgba(0,0,0,0.8); border: 2px solid #fff; transform: skew(-15deg); position: relative; margin-bottom: 10px; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        /* Horizontal bars (top) need width transition, Vertical (bottom) need height. We handle this in JS/CSS specific contexts */
        .bar-wrap .bar-fill { height: 100%; transition: width 0.1s; } 

        #hp-fill { background: linear-gradient(90deg, #f05, #f44); width: 100%; box-shadow: 0 0 15px #f05; }
        #xp-fill { background: linear-gradient(90deg, #0fa, #4fc); width: 0%; box-shadow: 0 0 15px #0fa; }
        
        .bar-text { position: absolute; top: 1px; left: 10px; font-size: 9px; color: #fff; text-shadow: 1px 1px 0 #000; font-family: 'Roboto'; letter-spacing: 1px; }

        #center-hud { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; width: 100px; color: #fff; text-shadow: 0 0 20px #0af; transition: 0.1s; }
        #score-val { font-size: 40px; margin: 0; line-height: 1; color: #0af; }
        #wep-display { font-size: 20px; color: #ff0; margin-top: 5px; text-shadow: 0 0 10px #ff0; }
        
        #combo-box { font-size: 30px; color: #fc0; font-family: 'Press Start 2P'; display: none; margin-top: 10px; animation: pulse 0.1s infinite alternate; text-shadow: 2px 2px 0 #000; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }
        #ach-toast { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 2px solid #fc0; padding: 15px 30px; color: #fc0; font-family: 'Press Start 2P'; font-size: 16px; display: none; z-index: 100; box-shadow: 0 0 20px #fc0; text-align: center; }

        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); backdrop-filter: blur(5px); z-index: 20; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: auto; transition: opacity 0.5s; }
        .hidden { display: none !important; }
        
        h1 { font-size: 10vw; color: transparent; -webkit-text-stroke: 1px #f05; text-shadow: 0 0 20px #f05; margin: 0; text-align: center; line-height: 0.9; }
        .btn { margin-top: 8px; padding: 12px 30px; font-size: 16px; font-family: 'Orbitron'; color: #0fa; background: rgba(0,255,170,0.1); border: 2px solid #0fa; cursor: pointer; transition: 0.2s; text-transform: uppercase; box-shadow: 0 0 20px #0fa; min-width: 180px; }
        .btn:hover { background: #0fa; color: #000; box-shadow: 0 0 60px #0fa; transform: scale(1.05); }
        .btn-cls { border-color: #f05; color: #f05; box-shadow: 0 0 20px #f05; }
        .btn-cls:hover { background: #f05; box-shadow: 0 0 60px #f05; }

        .cards-container { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; height: 60vh; overflow-y: auto; padding-bottom: 20px; }
        .card { width: 80vw; height: auto; min-height: 80px; flex-direction: row; justify-content: flex-start; text-align: left; padding: 10px; align-items: center; border: 2px solid #fc0; background: rgba(20,20,20,0.95); color: #fff; display: flex; cursor: pointer; transition: 0.3s; box-shadow: 0 0 15px #fc0; }
        .card:hover { transform: translateY(-20px) scale(1.05); background: #fc0; color: #000; }
        .c-icon { font-size: 30px; margin-bottom: 0; margin-right: 15px; width: 40px; text-align: center;}
        
        #shop-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 30px; }
        .shop-item { border: 1px solid #0fa; padding: 8px; width: 100%; box-sizing: border-box; background: rgba(0,20,10,0.8); display: flex; justify-content: space-between; align-items: center; }
        .shop-info div:first-child { color: #0fa; font-weight: bold; margin-bottom: 5px; }
        .shop-info div:last-child { color: #aaa; font-size: 12px; font-family: 'Roboto'; }
        .shop-btn { padding: 5px 15px; font-size: 14px; background: #000; border: 1px solid #0fa; color: #fff; cursor: pointer; }
        .shop-btn:hover { background: #0fa; color: #000; }
        .shop-btn.disabled { opacity: 0.5; cursor: not-allowed; border-color: #555; }

        #overlay-fx { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 5; transition: opacity 0.5s; mix-blend-mode: overlay; }
        .fx-damage { box-shadow: inset 0 0 100px #f00; opacity: 0; }
        .fx-ult { background: rgba(255, 255, 0, 0.1); border: 10px solid #f0f; opacity: 0; }
        
        #intro-screen { background: #000; z-index: 100; cursor: default; font-family: 'Press Start 2P', monospace; overflow: hidden; }
        .intro-text-layer { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; z-index: 20; }
        .skip-btn { position: absolute; bottom: 20px; right: 20px; color: #555; font-size: 14px; cursor: pointer; font-family: 'Orbitron'; text-transform: uppercase; letter-spacing: 2px; z-index: 30; }
        .skip-btn:hover { color: #fff; text-shadow: 0 0 10px #fff; }
        
        .intro-line { font-size: 5vw; color: #fff; margin-bottom: 25px; opacity: 0; text-shadow: 2px 2px 0 #000; line-height: 1.6; }
        .intro-active { opacity: 1; }
        .glitch-text { color: #f00; font-size: 10vw; font-weight: bold; text-shadow: 3px 0 #0ff, -3px 0 #f0f; animation: shk 0.1s infinite; }
        @keyframes shk { 0% { transform: translate(1px, 1px); } 100% { transform: translate(-1px, -1px); } }
    
        .c-title { font-size: 16px; color: #fc0; font-weight: bold; } .c-desc { font-size: 12px; color: #aaa; } .hud-top { flex-direction: row; justify-content: space-between; width: 100%; } .bar-wrap { transform: skew(0deg) !important; border-radius: 4px; border: 1px solid #fff; margin-bottom: 4px; } #center-hud { top: 60px; } .shop-info div:first-child { font-size: 14px; } .shop-info div:last-child { font-size: 10px; }
</style>
</head>
<body oncontextmenu="return false;">

    <canvas id="cvs"></canvas>
    <div id="overlay-fx"></div>

<div id="ui-layer">
        <div class="hud-top">
            <div>
                <div class="bar-wrap"><div class="bar-text">–ó–î–û–†–û–í–¨–ï</div><div id="hp-fill" class="bar-fill"></div></div>
            </div>
            <div id="center-hud">
                <div id="score-val">0</div>
                <div style="font-size:14px; color:#aaa;">–£–í–û–õ–ï–ù–ù–´–•</div>
                <div id="combo-box">COMBO x<span id="combo-val">0</span></div>
                <div id="wep-display">–ü–ò–°–¢–û–õ–ï–¢</div>
            </div>
            <div style="text-align: right;">
                <div class="bar-wrap" style="border-color: #0fa;"><div class="bar-text" style="right: 10px; left: auto;">–û–ü–´–¢</div><div id="xp-fill" class="bar-fill"></div></div>
                <div style="color: #0fa; font-size: 14px; font-weight: bold;">–£–†–û–í–ï–ù–¨ <span id="lvl-val">1</span></div>
            </div>
        </div>
        
        <div class="hud-bottom">
            <div class="skill-btn" style="border-color: #f80;" ontouchstart="Game.activateGrenade(event)" onclick="Game.activateGrenade(event)">
                <div id="gren-fill" class="bar-fill"></div>
                <div class="skill-text">–ì–†–ê–ù–ê–¢–ê</div>
            </div>
            <div class="skill-btn" style="border-color: #f0f;" ontouchstart="Game.activateUlt(event)" onclick="Game.activateUlt(event)">
                <div id="ult-fill" class="bar-fill"></div>
                <div class="skill-text">–£–õ–¨–¢–ê</div>
            </div>
        </div>
    </div>
    
    <div id="ach-toast">ACHIEVEMENT!</div>

    <div id="intro-screen" class="screen">
        <canvas id="intro-bg" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 10;"></canvas>
        <div class="intro-text-layer" id="intro-content"></div>
        <div class="skip-btn" onclick="IntroSys.skip()">–ü–†–û–ü–£–°–¢–ò–¢–¨ [–ü–†–û–ë–ï–õ]</div>
    </div>

    <div id="screen-menu" class="screen hidden" style="opacity:0;">
        <h1>OFFICE<br>DOOM</h1>
        <h2 style="color: #fff; margin-top: 10px;">ULTIMATE EDITION</h2>
        <div style="color:#fc0; font-size:20px; margin-bottom:20px;">–ë–ê–õ–ê–ù–°: <span id="bank-val">0</span> $</div>
        <button class="btn" onclick="Game.start()">–ò–ì–†–ê–¢–¨</button>
        <button class="btn" onclick="Menu.openShop()">–ú–ê–ì–ê–ó–ò–ù</button>
        <button id="btn-music" class="btn" style="font-size:16px; padding:10px 30px; margin-top:10px;" onclick="toggleMusic()">–ú–£–ó–´–ö–ê: –í–ö–õ</button>
    </div>

    <div id="screen-shop" class="screen hidden">
        <h1 style="font-size:60px; -webkit-text-stroke: 2px #0fa; text-shadow: 0 0 30px #0fa;">–ú–ê–ì–ê–ó–ò–ù</h1>
        <div style="color:#fc0; font-size:24px;">–ë–ê–õ–ê–ù–°: <span id="shop-bank-val">0</span> $</div>
        <div id="shop-grid"></div>
        <button class="btn btn-cls" onclick="Menu.closeShop()">–ù–ê–ó–ê–î</button>
    </div>

    <div id="screen-lvl" class="screen hidden">
        <h1 style="-webkit-text-stroke: 1px #fc0; font-size: 12vw;">–ü–û–í–´–®–ï–ù–ò–ï!</h1>
        <div class="cards-container" id="cards-box"></div>
    </div>

    <div id="screen-over" class="screen hidden">
        <h1>–¢–´ –£–í–û–õ–ï–ù</h1>
        <h2 style="color: #fff;">–°–ß–ï–¢: <span id="final-score">0</span></h2>
        <h3 style="color: #fc0;">–ó–ê–†–ê–ë–û–¢–ê–ù–û: <span id="earned-val">0</span> $</h3>
        <button class="btn" onclick="location.reload()">–ù–û–í–û–ï –†–ï–ó–Æ–ú–ï</button>
    </div>

<script>
/** 
 * --- MUSIC SYSTEM --- 
 */
const MusicSys = {
    ctx: null, master: null, compressor: null, enabled: true,
    tick: 0, frameCounter: 0, framesPerBeat: 8,
    bassSeq: [55, 55, 55, 55, 49, 49, 44, 44], 
    init() {
        if (this.ctx) return;
        const AC = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AC();
        this.compressor = this.ctx.createDynamicsCompressor();
        this.master = this.ctx.createGain();
        this.master.gain.value = 0.4;
        this.master.connect(this.compressor); this.compressor.connect(this.ctx.destination);
    },
    update() {
        if (!this.enabled || !this.ctx) return;
        if (this.ctx.state === 'suspended') this.ctx.resume();
        this.frameCounter++;
        if (this.frameCounter >= this.framesPerBeat) { this.frameCounter = 0; this.playTick(); }
    },
    playTick() {
        const t = this.ctx.currentTime, step = this.tick % 16;
        if (step % 4 === 0) this.tone(120, 'sine', 0.2, 1.0, 0.01);
        if (step % 8 === 4) this.noise(t);
        if (step % 4 !== 0 || step === 0) this.tone(this.bassSeq[Math.floor(this.tick/16)%8], 'sawtooth', 0.15, 0.3);
        this.tick++;
    },
    tone(f, type, dur, vol, slide) {
        if(!this.ctx) return; const t=this.ctx.currentTime, o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.type=type; o.frequency.setValueAtTime(f,t); if(slide)o.frequency.exponentialRampToValueAtTime(slide,t+dur);
        g.gain.setValueAtTime(vol,t); g.gain.exponentialRampToValueAtTime(0.001,t+dur);
        o.connect(g); g.connect(this.master); o.start(t); o.stop(t+dur+0.1);
    },
    noise(t) {
        if(!this.ctx) return; const o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.type='sawtooth'; o.frequency.setValueAtTime(200,t); o.frequency.linearRampToValueAtTime(50,t+0.1);
        g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1);
        o.connect(g); g.connect(this.master); o.start(t); o.stop(t+0.15);
    },
    playSfx(f, type, dur, vol) {
        if(!this.enabled || !this.ctx) return; const t=this.ctx.currentTime;
        const o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.type=type; o.frequency.setValueAtTime(f,t);
        g.gain.setValueAtTime(vol,t); g.gain.exponentialRampToValueAtTime(0.001,t+dur);
        o.connect(g); g.connect(this.master); o.start(t); o.stop(t+dur+0.05);
    },
    shoot(){ this.playSfx(250,'square',0.08,0.1); }, shotgun(){ this.playSfx(150,'sawtooth',0.12,0.15); },
    flame(){ if(this.tick%4===0)this.playSfx(100,'sawtooth',0.2,0.1); },
    hit(){ this.playSfx(80,'sawtooth',0.1,0.2); }, pickup(){ this.playSfx(800,'sine',0.15,0.1); },
    heal(){ this.playSfx(400,'sine',0.3,0.2); setTimeout(()=>this.playSfx(600,'sine',0.3,0.2),100); },
    boss(){ this.playSfx(50,'sawtooth',1.0,0.5); }, dash(){ this.playSfx(400,'triangle',0.2,0.1); },
    ult(){ this.tone(100,'sawtooth',1.0,0.3); setTimeout(()=>this.tone(200,'sawtooth',1.0,0.3),200); },
    lvlup(){ if(!this.ctx) return; this.playSfx(440,'triangle',0.3,0.2); setTimeout(()=>this.playSfx(880,'triangle',0.3,0.2),200); },
    ach(){ if(!this.ctx) return; this.playSfx(600,'sine',0.3,0.2); setTimeout(()=>this.playSfx(1200,'sine',0.3,0.2),200); },
    
    type(){ try{this.playSfx(800,'square',0.05,0.05);}catch(e){} },
    slam(){ try{this.tone(50,'sawtooth',0.8,1.0); this.noise(this.ctx.currentTime);}catch(e){} }
};
function toggleMusic() {
    MusicSys.enabled = !MusicSys.enabled;
    const btn = document.getElementById('btn-music');
    if(MusicSys.enabled) { btn.innerText = "–ú–£–ó–´–ö–ê: –í–ö–õ"; if(MusicSys.ctx) MusicSys.ctx.resume(); } else { btn.innerText = "–ú–£–ó–´–ö–ê: –í–´–ö–õ"; }
}

/** --- ROBUST INTRO SYSTEM --- */
const IntroSys = {
    step: 0, charIdx: 0, timer: 0, active: true, 
    bgCvs: null, bgCtx: null, content: null,
    // SCENE DEFINITIONS: type 'text' types out. type 'wait' just sits there. type 'visual' is the eyes.
    scenes: [
        { type:'text', t:"2026 –ì–û–î. –û–§–ò–° –ö–û–†–ü–û–†–ê–¶–ò–ò.", c:"#fff", s:20 },
        { type:'text', t:"–¢–´ –û–¢–î–ê–õ–ê –ò–ú –í–°–Å.", c:"#ccc", s:20 },
        { type:'text', t:"–¢–í–û–ô –ö–û–î –ë–´–õ –ò–î–ï–ê–õ–ï–ù.", c:"#ccc", s:20 },
        { type:'text', t:"–ù–û –ò–ú –ù–£–ñ–ï–ù –ö–û–ó–ï–õ –û–¢–ü–£–©–ï–ù–ò–Ø.", c:"#ccc", s:20 },
        { type:'text', t:"–ü–†–ò–ö–ê–ó #666: –°–û–ö–†–ê–©–ï–ù–ò–ï.", c:"#f55", s:24 },
        { type:'text', t:"–í–´ –£–í–û–õ–ï–ù–´!!!", c:"#f00", big:true, shake:true }, // The big moment
        { type:'wait', d: 60 }, // Pause to read
        { type:'visual', d: 150 } // The EYES
    ],

    init() {
        this.content = document.getElementById('intro-content');
        this.bgCvs = document.getElementById('intro-bg');
        this.bgCtx = this.bgCvs.getContext('2d');
        this.resize(); window.addEventListener('resize', ()=>this.resize());
        this.startScene();
        this.loop();
    },
    resize() { this.bgCvs.width = window.innerWidth; this.bgCvs.height = window.innerHeight; },

    startScene() {
        if(this.step >= this.scenes.length) { this.end(); return; }
        const s = this.scenes[this.step];
        
        if(s.type === 'text') {
            const el = document.createElement('div');
            el.className = 'intro-line';
            if(s.big) { el.className += " glitch-text"; MusicSys.slam(); }
            else el.style.fontSize = s.s+"px";
            el.style.color = s.c;
            this.content.appendChild(el);
            this.currEl = el;
            this.currText = "";
            this.targetText = s.t;
            this.charIdx = 0;
            if(s.shake) document.body.style.transform = "translate(5px, 5px)";
        }
    },

    loop() {
        if(!this.active) return;
        requestAnimationFrame(()=>this.loop());
        
        // Background Noise (CRT Effect)
        const w = this.bgCvs.width, h = this.bgCvs.height;
        this.bgCtx.clearRect(0,0,w,h);
        this.bgCtx.fillStyle = "rgba(255, 255, 255, 0.02)";
        for(let i=0; i<20; i++) this.bgCtx.fillRect(Math.random()*w, Math.random()*h, Math.random()*100, 2);
        // Scanline
        this.bgCtx.fillStyle = "rgba(0, 255, 0, 0.05)";
        this.bgCtx.fillRect(0, (Date.now()/5)%h, w, 5);

        // Scene Logic
        const s = this.scenes[this.step];
        if(!s) return; // Should not happen due to end()

        if(s.type === 'text') {
            if(this.timer++ % 3 === 0 && this.charIdx < this.targetText.length) {
                this.currText += this.targetText[this.charIdx];
                this.currEl.innerText = this.currText;
                this.currEl.style.opacity = 1;
                this.charIdx++;
                MusicSys.type();
            }
            if(this.charIdx >= this.targetText.length && this.timer > 30 && this.timer % 80 === 0) {
                this.advance();
            }
        } 
        else if(s.type === 'wait') {
            if(this.timer++ > s.d) this.advance();
        }
        else if(s.type === 'visual') {
            // Draw Eyes
            document.body.style.transform = "none"; // Reset shake
            const cx = w/2, cy = h/2 + 100;
            const flicker = Math.random() > 0.1 ? 1 : 0.5;
            this.bgCtx.fillStyle = `rgba(255, 0, 0, ${flicker})`;
            this.bgCtx.shadowBlur = 30; this.bgCtx.shadowColor = "#f00";
            // Left Eye
            this.bgCtx.beginPath(); this.bgCtx.moveTo(cx-150, cy); this.bgCtx.lineTo(cx-50, cy+40); this.bgCtx.lineTo(cx-150, cy+20); this.bgCtx.fill();
            // Right Eye
            this.bgCtx.beginPath(); this.bgCtx.moveTo(cx+150, cy); this.bgCtx.lineTo(cx+50, cy+40); this.bgCtx.lineTo(cx+150, cy+20); this.bgCtx.fill();
            this.bgCtx.shadowBlur = 0;
            
            if(this.timer++ > s.d) this.advance();
        }
    },

    advance() {
        this.step++;
        this.timer = 0;
        this.startScene();
    },

    skip() { this.end(); },
    end() {
        if(!this.active) return;
        this.active = false;
        MusicSys.slam();
        document.body.style.transform = "none";
        document.getElementById('intro-screen').style.opacity = 0;
        setTimeout(()=>{
            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('screen-menu').classList.remove('hidden');
            setTimeout(()=>document.getElementById('screen-menu').style.opacity=1, 100);
        }, 800);
    }
};

/** --- DIALOGUE & DATA --- */
const QUIPS_DB = {
    intern: ["–Ø –¢–û–õ–¨–ö–û –°–ü–†–û–°–ò–¢–¨!", "–ì–î–ï –ö–£–õ–ï–†?", "–ù–ï –ë–ï–ô–¢–ï, –Ø –°–¢–ê–ñ–ï–†!", "–≠–¢–û –ù–ï –í –ú–û–ï–ô JIRA", "–ú–ù–ï –ù–ï –ü–õ–ê–¢–Ø–¢!"],
    manager: ["–î–ê–í–ê–ô–¢–ï –°–ò–ù–ö–ê–ù–ï–ú–°–Ø", "–¢–´ –¢–û–ö–°–ò–ß–ù–ê–Ø!", "–≠–¢–û –ù–ï –ü–û –û–ö–†!", "–í–´–®–õ–Æ –ò–ù–í–ê–ô–¢", "–î–ï–õ–ê–ï–ú –†–ï–¢–†–û–°–ü–ï–ö–¢–ò–í–£"],
    sysadmin: ["–í–´–ö–õ–Æ–ß–ò –ò –í–ö–õ–Æ–ß–ò", "–¢–ò–ö–ï–¢ –°–û–ó–î–ê–õ–ê?", "–Ø –ü–ò–ù–ì–£–Æ...", "–£ –ú–ï–ù–Ø –û–ë–ï–î", "–§–ê–ô–†–í–û–õ –ê–ö–¢–ò–í–ï–ù"],
    hr: ["–ú–´ –í–ê–ú –ü–ï–†–ï–ó–í–û–ù–ò–ú", "–í–´–ì–û–†–ê–ù–ò–ï - –≠–¢–û –ú–ò–§", "–ì–î–ï –í–ê–®–ê –õ–û–Ø–õ–¨–ù–û–°–¢–¨?", "–£ –ù–ê–° –¢–ò–ú–ë–ò–õ–î–ò–ù–ì!", "–ó–ê–†–ü–õ–ê–¢–ê –í –ö–û–ù–í–ï–†–¢–ï"],
    ceo: ["–¢–í–û–ô KPI –ù–ê –î–ù–ï!", "–õ–ò–®–ê–Æ –ü–†–ï–ú–ò–ò!", "–°–û–ö–†–ê–©–ï–ù–ò–ï –®–¢–ê–¢–ê!", "–Ø –ö–£–ü–õ–Æ –¢–í–û–Æ –ñ–ò–ó–ù–¨!", "–í–†–ï–ú–Ø –î–ï–ù–¨–ì–ò!"],
    
    // Player Quips
    player_kill: ["–°–õ–ï–î–£–Æ–©–ò–ô –°–õ–ê–ô–î!", "–í –ê–†–•–ò–í!", "–û–¢–ö–ê–ó–ê–ù–û!", "–ü–û–î–ü–ò–®–ò –≠–¢–û!", "–í–´–ì–û–†–ï–õ –ù–ê –†–ê–ë–û–¢–ï?", "–ë–ï–ó –í–´–•–û–î–ù–û–ì–û!"],
    player_wep: ["–í–†–ï–ú–Ø –ü–ï–†–ï–ì–û–í–û–†–û–í!", "–ú–û–ô –ó–û–õ–û–¢–û–ô –ü–ê–†–ê–®–Æ–¢!", "–ê–†–ì–£–ú–ï–ù–¢ –í–ï–°–û–ú–´–ô!", "–ü–†–ï–ú–ò–Ø –ü–†–ò–®–õ–ê!"],
    player_ult: ["–ê–ê–ê–ê–ê–ê–ê!!!", "–î–ï–ü–û–ù–ò–†–£–ô –≠–¢–û!!!", "–Ø –í –†–ï–°–£–†–°–ï!!!", "–¢–û–¢–ê–õ–¨–ù–û–ï –°–û–ö–†–ê–©–ï–ù–ò–ï!"],
    player_boss: ["–í–ê–® –ö–û–õ–õ –ó–ê–ö–û–ù–ß–ï–ù.", "–°–ú–ï–ù–ê –†–£–ö–û–í–û–î–°–¢–í–ê.", "–†–´–ù–û–ö –ü–û–†–ï–®–ê–õ."]
};

// ACHIEVEMENTS
const ACH_LIST = [
    {id:'kill10', t:"–£–ë–ò–¢–¨ 10 –í–†–ê–ì–û–í", c:s=>s.kills>=10, r:50},
    {id:'kill50', t:"–£–ë–ò–¢–¨ 50 –í–†–ê–ì–û–í", c:s=>s.kills>=50, r:200},
    {id:'combo10', t:"–ö–û–ú–ë–û x10", c:s=>s.maxCombo>=10, r:100},
    {id:'boss', t:"–£–ë–ò–¢–¨ –ë–û–°–°–ê", c:s=>s.bossKills>=1, r:500}
];

const Save = {
    data: { bank: 0, upg: { hp:0, dmg:0 }, stats:{kills:0, maxCombo:0, bossKills:0}, ach:[] },
    load() { try{const s=localStorage.getItem('sq_doom_save_redux'); if(s){const p=JSON.parse(s);this.data={...this.data,...p,upg:{...this.data.upg,...(p.upg||{})}, stats:{...this.data.stats,...(p.stats||{})} };}}catch(e){} this.updateUI(); },
    save() { localStorage.setItem('sq_doom_save_redux', JSON.stringify(this.data)); this.updateUI(); },
    addMoney(v) { this.data.bank+=v; this.save(); },
    checkAch() {
        ACH_LIST.forEach(a => {
            if(!this.data.ach.includes(a.id) && a.c(this.data.stats)) {
                this.data.ach.push(a.id);
                this.data.bank += a.r;
                this.showToast(a.t + " +"+a.r+"$");
                this.save();
                MusicSys.ach();
            }
        });
    },
    showToast(t) {
        const el=document.getElementById('ach-toast'); el.innerText=t; el.style.display='block';
        setTimeout(()=>el.style.display='none', 3000);
    },
    updateUI() { if(document.getElementById('bank-val')){document.getElementById('bank-val').innerText=this.data.bank; document.getElementById('shop-bank-val').innerText=this.data.bank;} }
};
const SHOP_ITEMS = [{id:'hp',n:"–ó–î–û–†–û–í–¨–ï +10",c:100,m:5},{id:'dmg',n:"–£–†–û–ù +5%",c:250,m:5}];
const Menu = {
    openShop(){document.getElementById('screen-menu').classList.add('hidden');document.getElementById('screen-shop').classList.remove('hidden');this.renderShop();},
    closeShop(){document.getElementById('screen-shop').classList.add('hidden');document.getElementById('screen-menu').classList.remove('hidden');},
    renderShop(){
        const g=document.getElementById('shop-grid');g.innerHTML='';
        SHOP_ITEMS.forEach(i=>{
            const l=Save.data.upg[i.id];
            const d=document.createElement('div');d.className='shop-item';
            d.innerHTML=`<div class="shop-info"><div>${i.n}</div><div>–£—Ä–æ–≤–µ–Ω—å: ${l}/${i.m}</div></div><button class="shop-btn ${l>=i.m||Save.data.bank<i.c?'disabled':''}" onclick="Menu.buy('${i.id}')">${l>=i.m?'–ú–ê–ö–°':i.c+'$'}</button>`;
            g.appendChild(d);
        });
    },
    buy(id){const i=SHOP_ITEMS.find(x=>x.id===id);if(Save.data.upg[id]<i.m && Save.data.bank>=i.c){Save.data.bank-=i.c;Save.data.upg[id]++;Save.save();this.renderShop();}}
};

/** --- GAME --- */
const WEAPONS = [
    {name:"–ü–ò–°–¢–û–õ–ï–¢", rate:10, dmg:25, spd:20, c:'#ff0', count:1, spread:0.05},
    {name:"–î–†–û–ë–û–í–ò–ö", rate:35, dmg:18, spd:18, c:'#fa0', count:5, spread:0.3},
    {name:"–ú–ò–ù–ò–ì–ê–ù", rate:4, dmg:12, spd:22, c:'#0ff', count:1, spread:0.15},
    {name:"–ö–û–§–ï–ú–ï–¢", rate:3, dmg:8, spd:15, c:'#6f4e37', count:1, spread:0.2, pierce:true, life:20}, 
    {name:"–†–ê–ö–ï–¢–ù–ò–¶–ê", rate:50, dmg:80, spd:15, c:'#f50', count:1, spread:0, boom:true}
];

const cvs = document.getElementById('cvs'), ctx = cvs.getContext('2d');
let W, H; 
function resize(){ 
    const aspectRatio = 9 / 16;
    if (window.innerWidth / window.innerHeight < aspectRatio) {
        W = cvs.width = window.innerWidth;
        H = cvs.height = W / aspectRatio;
    } else {
        H = cvs.height = window.innerHeight;
        W = cvs.width = H * aspectRatio;
    }
}
window.addEventListener('resize', resize);

const Game = {
    state:'MENU', frame:0, score:0, cam:{x:0,y:0,shake:0,zoom:0.3}, keys:{}, mouse:{x:0,y:0, r:false},
    player:null, enemies:[], bullets:[], pickups:[], texts:[], decals:[], drops:[],
    timeScale: 1.0, ultActive: false,
    combo:0, comboTimer:0,
    
    start() {
        resize(); MusicSys.init(); if(MusicSys.ctx) MusicSys.ctx.resume();
        document.getElementById('screen-menu').classList.add('hidden');
        document.getElementById('ui-layer').style.opacity = 1;
        this.player = new Player();
        this.enemies=[]; this.bullets=[]; this.pickups=[]; this.texts=[]; this.decals=[]; this.drops=[];
        this.score=0; this.frame=0; this.combo=0; this.state='PLAY';
        loop();
    },
    spawnEnemy() {
        const r=Math.random(), a=Math.random()*6.28, d=(Math.hypot(W,H)/Game.cam.zoom)/2 + 500;
        let t='intern'; 
        if(this.score>20 && r<0.4) t='manager';
        if(this.score>40 && r<0.2) t='sysadmin'; 
        if(this.score>50 && r<0.1) t='guard'; // NEW ENEMY
        if(this.score>60 && r<0.15) t='hr'; 
        if(this.player.lvl>=5 && !this.enemies.find(e=>e.type==='ceo') && Math.random()<0.05) { t='ceo'; MusicSys.boss(); Game.spawnText(this.player.x, this.player.y-100, "–ì–ï–ù–î–ò–†–ï–ö–¢–û–†!", "#f00", 2.0); }
        this.enemies.push(new Enemy(t, this.player.x+Math.cos(a)*d, this.player.y+Math.sin(a)*d));
    },
    spawnText(x, y, txt, col, scale=1.0) { this.texts.push({x, y, txt, col, life:60, vy:-1.5, scale}); },
    say(txt, source) { 
        const col = source==='player' ? '#0ff' : '#fff';
        const x = source==='player' ? this.player.x : source.x;
        const y = source==='player' ? this.player.y - 60 : source.y - 40;
        this.spawnText(x, y, txt, col, source==='player'?1.5:1.0);
    },
    addCombo() { 
        this.combo++; this.comboTimer=120; 
        if(this.combo>Save.data.stats.maxCombo) Save.data.stats.maxCombo=this.combo;
        const el=document.getElementById('combo-box'); el.style.display='block'; document.getElementById('combo-val').innerText=this.combo;
        Save.checkAch();
    },
    resetCombo() { this.combo=0; document.getElementById('combo-box').style.display='none'; },
    pause() { this.state='PAUSE'; document.getElementById('screen-lvl').classList.remove('hidden'); generateCards(); },
    resume() { this.state='PLAY'; document.getElementById('screen-lvl').classList.add('hidden'); if(MusicSys.ctx) MusicSys.ctx.resume(); },
    over() { 
        this.state='OVER'; document.getElementById('screen-over').classList.remove('hidden'); 
        document.getElementById('final-score').innerText=this.score;
        Save.addMoney(this.score * 5); document.getElementById('earned-val').innerText = this.score * 5;
    },
    activateGrenade(e) {
        if(e) { e.preventDefault(); e.stopPropagation(); }
        if(this.state !== 'PLAY' || !this.player) return;
        this.player.throwGrenade();
    },
    activateUlt(e) {
        if(e) { e.preventDefault(); e.stopPropagation(); }
        if(this.state !== 'PLAY' || !this.player) return;
        this.player.activateUlt();
    }
};

class Player {
    constructor() { 
        this.x=0;this.y=0;this.maxHp=100+Save.data.upg.hp*10;this.hp=this.maxHp;
        this.xp=0;this.maxXp=10;this.lvl=1;this.speed=6;this.angle=0;this.anim=0;this.lastShot=0;this.lastMoveAngle=0;
        this.wep=WEAPONS[0]; this.wepT=0;
        this.bon={mul:0, dmg:1+Save.data.upg.dmg*0.05, spd:1, mag:0};
        this.grenadeCd=0; this.maxGrenadeCd=180;
        this.ult=0; this.maxUlt=100;
    }
    
    activateUlt() {
        if(this.ult >= this.maxUlt && !Game.ultActive) {
            Game.ultActive = true; MusicSys.ult(); this.ult=0;
            Game.say(QUIPS_DB.player_ult[Math.floor(Math.random()*QUIPS_DB.player_ult.length)], 'player');
        }
    }

    throwGrenade() {
        if(this.grenadeCd <= 0) {
            this.grenadeCd = this.maxGrenadeCd;
            let ga = this.lastMoveAngle; 
            if(Game.enemies.length > 0) { 
                let nearest = null, minDist = Infinity; 
                Game.enemies.forEach(e => { const d = Math.hypot(e.x - this.x, e.y - this.y); if(d < minDist) { minDist = d; nearest = e; } }); 
                if(nearest) ga = Math.atan2(nearest.y - this.y, nearest.x - this.x); 
            }
            Game.bullets.push({x:this.x, y:this.y, vx:Math.cos(ga)*12, vy:Math.sin(ga)*12, life:40, dmg:100, boom:true, c:'#f80', grenade:true});
        }
    }

    update() {
        if(this.hp < 20) document.getElementById('overlay-fx').className = 'fx-damage';
        else if(Game.ultActive) document.getElementById('overlay-fx').className = 'fx-ult';
        else document.getElementById('overlay-fx').className = '';

        if(Game.keys['KeyQ']) this.activateUlt(); // Keyboard fallback

        if(Game.ultActive) {
            Game.timeScale = 0.3; this.speed = 10; this.ult += 0.5; 
            if(this.ult >= 100) { Game.ultActive=false; this.ult=0; Game.timeScale=1.0; this.speed=6; }
        } else Game.timeScale = 1.0;

        Game.cam.x+=(this.x-W/2-Game.cam.x)*0.1; Game.cam.y+=(this.y-H/2-Game.cam.y)*0.1;
        this.angle=Math.atan2(Game.mouse.y-(this.y-Game.cam.y), Game.mouse.x-(this.x-Game.cam.x));
        
        let dx=0,dy=0; if(Game.keys['KeyW'])dy=-1;if(Game.keys['KeyS'])dy=1;if(Game.keys['KeyA'])dx=-1;if(Game.keys['KeyD'])dx=1;
        const l=Math.hypot(dx,dy);
        if(l>0) this.lastMoveAngle = Math.atan2(dy,dx);
        
        if(this.grenadeCd>0) this.grenadeCd--;

        if(l>0.1){ this.x+=(dx/l)*this.speed*this.bon.spd; this.y+=(dy/l)*this.speed*this.bon.spd; this.anim+=0.3; } else this.anim=0;
        
        
        // SMART AUTO-FIRE
        let nearest = null, minDist = Infinity;
        Game.enemies.forEach(e => { const d = Math.hypot(e.x - this.x, e.y - this.y); if(d < minDist) { minDist = d; nearest = e; } });
        
        const AUTO_RADIUS = 400; 
        let shouldShoot = (Game.keys['Space'] || Game.mouse.down); 
        
        if (nearest && minDist < AUTO_RADIUS) {
            shouldShoot = true;
        }

        if(shouldShoot && Game.frame - this.lastShot >= this.wep.rate){ 
            this.shoot(); 
            this.lastShot=Game.frame; 
        }
        
        if(Game.keys['KeyQ']) this.activateUlt();
        if(Game.mouse.r) this.throwGrenade();

        if(this.wepT>0){ this.wepT--; if(this.wepT<=0) this.wep=WEAPONS[0]; }
        
        document.getElementById('hp-fill').style.width=Math.max(0,this.hp/this.maxHp*100)+'%';
        
        // Update Skill Buttons
        document.getElementById('gren-fill').style.height=Math.max(0,(1-this.grenadeCd/this.maxGrenadeCd)*100)+'%';
        document.getElementById('ult-fill').style.height = Game.ultActive ? (100-this.ult)+'%' : (this.ult/this.maxUlt*100)+'%';

        document.getElementById('xp-fill').style.width=this.xp/this.maxXp*100+'%';
        document.getElementById('lvl-val').innerText=this.lvl; document.getElementById('score-val').innerText=Game.score;
        const wd=document.getElementById('wep-display'); wd.innerText=this.wep.name; wd.style.color=this.wep.c;
    }
    shoot() {
        Game.cam.shake=this.wep.rate<5?1:5; Game.cam.zoom=0.31;
        if(this.wep.name==='–ö–û–§–ï–ú–ï–¢') MusicSys.flame(); else if(this.wep.name==='–î–†–û–ë–û–í–ò–ö') MusicSys.shotgun(); else MusicSys.shoot();
        const cnt=this.wep.count+this.bon.mul;
        let shootAngle; if(Game.enemies.length > 0) { let nearest = null, minDist = Infinity; Game.enemies.forEach(e => { const d = Math.hypot(e.x - this.x, e.y - this.y); if(d < minDist) { minDist = d; nearest = e; } }); shootAngle = nearest ? Math.atan2(nearest.y - this.y, nearest.x - this.x) : this.lastMoveAngle; } else { shootAngle = this.lastMoveAngle; }
        for(let i=0;i<cnt;i++) {
            const s=(Math.random()-0.5)*this.wep.spread, a=shootAngle+s+(cnt>1?(i-cnt/2)*0.1:0);
            Game.bullets.push({
                x:this.x+Math.cos(shootAngle)*30, y:this.y+Math.sin(shootAngle)*30,
                vx:Math.cos(a)*this.wep.spd, vy:Math.sin(a)*this.wep.spd,
                life:this.wep.life||60, dmg:this.wep.dmg*this.bon.dmg, c:this.wep.c, boom:this.wep.boom, pierce:this.wep.pierce
            });
        }
    }
}

class Enemy {
    constructor(t,x,y) { 
        this.type=t;this.x=x;this.y=y;this.anim=Math.random()*10;this.push={x:0,y:0}; 
        if(t==='intern'){this.hp=120;this.r=20;this.s=3;this.xp=1;}
        else if(t==='manager'){this.hp=480;this.r=35;this.s=2;this.xp=3;}
        else if(t==='guard'){this.hp=1000;this.r=40;this.s=1.2;this.xp=8;} 
        else if(t==='sysadmin'){this.hp=800;this.r=30;this.s=1.5;this.xp=5;}
        else if(t==='hr'){this.hp=240;this.r=25;this.s=2.5;this.xp=4;}
        else if(t==='ceo'){this.hp=8000;this.r=60;this.s=1;this.xp=100;} 
        this.maxHp=this.hp;
    }
    update() {
        this.anim+=0.2; 
        const a=Math.atan2(Game.player.y-this.y,Game.player.x-this.x);
        this.x+=Math.cos(a)*this.s*Game.timeScale + this.push.x; 
        this.y+=Math.sin(a)*this.s*Game.timeScale + this.push.y;
        this.push.x*=0.85;this.push.y*=0.85;

        if(this.type==='hr' && Game.frame%300===0) { Game.enemies.push(new Enemy('intern', this.x, this.y)); Game.spawnText(this.x, this.y, "–ù–ê–ô–ú!", "#0f0"); }
        if(this.type==='ceo' && Game.frame%100===0) { for(let i=0;i<12;i++) { const ang=a+(i-6)*0.2; Game.bullets.push({x:this.x,y:this.y,vx:Math.cos(ang)*5,vy:Math.sin(ang)*5,life:100,dmg:20,c:'#f0f',enemy:true}); } }
        Game.enemies.forEach(e=>{if(e!==this && Math.hypot(this.x-e.x,this.y-e.y)<this.r+e.r){const ag=Math.atan2(this.y-e.y,this.x-e.x);this.x+=Math.cos(ag);this.y+=Math.sin(ag);}});
        if(Math.hypot(Game.player.x-this.x,Game.player.y-this.y)<this.r+15){ Game.player.hp-=0.5; Game.cam.shake=2; if(Game.player.hp<=0)Game.over(); }
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x,this.y); const w=Math.sin(this.anim)*3;
        ctx.fillStyle='rgba(0,0,0,0.5)';ctx.beginPath();ctx.ellipse(0,15,this.r,this.r/2,0,0,7);ctx.fill();
        if(this.type==='intern'){
            ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(0,0,this.r,0,7);ctx.fill();
            ctx.fillStyle='#06c';ctx.beginPath();ctx.moveTo(-5,5);ctx.lineTo(5,5);ctx.lineTo(0,20);ctx.fill();
            ctx.fillStyle='#654';ctx.fillRect(10,5+w,8,10);
            ctx.fillStyle='#000';ctx.beginPath();ctx.arc(-5,-5,2,0,7);ctx.arc(5,-5,2,0,7);ctx.fill();
        } else if(this.type==='manager'){
            const s=1+Math.sin(this.anim*0.5)*0.05; ctx.scale(s,s);
            ctx.fillStyle='#409';ctx.beginPath();ctx.arc(0,0,this.r,0,7);ctx.fill();
            ctx.strokeStyle='#fff';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(-15,-10);ctx.lineTo(-5,-5);ctx.moveTo(15,-10);ctx.lineTo(5,-5);ctx.stroke();
        } else if(this.type==='guard'){
            ctx.fillStyle='#333';ctx.beginPath();ctx.arc(0,0,this.r,0,7);ctx.fill();
            ctx.fillStyle='#fa0';ctx.fillRect(-10,-10,20,20); /* Vest */
        } else if(this.type==='sysadmin'){
            ctx.fillStyle='#334';ctx.beginPath();ctx.arc(0,0,this.r,0,7);ctx.fill();
            ctx.fillStyle='#0af';ctx.shadowBlur=10;ctx.shadowColor='#0af';ctx.beginPath();ctx.arc(15,0,5,0,7);ctx.arc(-15,0,5,0,7);ctx.fill();ctx.shadowBlur=0;
            ctx.strokeStyle='#0af';ctx.lineWidth=4;ctx.beginPath();ctx.arc(0,0,this.r+5,Math.PI,0);ctx.stroke();
        } else if(this.type==='hr'){
            ctx.fillStyle='#d06';ctx.beginPath();ctx.arc(0,0,this.r,0,7);ctx.fill();
            ctx.fillStyle='#fff';ctx.font='20px Arial';ctx.fillText('HR',-12,8);
        } else if(this.type==='ceo'){
            ctx.fillStyle='#222';ctx.beginPath();ctx.arc(0,0,this.r,0,7);ctx.fill();
            ctx.fillStyle='#f00';ctx.font='30px Arial';ctx.fillText("CEO",-30,10);
            ctx.strokeStyle='#f00';ctx.lineWidth=5;ctx.beginPath();ctx.arc(0,0,this.r+5,0,7);ctx.stroke();
        }
        if(this.hp<this.maxHp){ ctx.fillStyle='#f00';ctx.fillRect(-20,-this.r-10,40,4); ctx.fillStyle='#0f0';ctx.fillRect(-20,-this.r-10,40*(this.hp/this.maxHp),4); }
        ctx.restore();
    }
}

function loop() {
    if(Game.state==='PLAY') {
        Game.frame++; MusicSys.update();
        if(Game.comboTimer>0) { Game.comboTimer--; if(Game.comboTimer<=0) Game.resetCombo(); }
        if(Game.frame%(Math.max(20,60-Math.floor(Game.score/5)))===0)Game.spawnEnemy();
        Game.player.update();
        
        Game.enemies.forEach(e=>{
            e.update();
            Game.bullets.forEach(b=>{
                if(!b.enemy && Math.hypot(b.x-e.x,b.y-e.y)<e.r+15 && b.life>0){
                    let dmg = b.dmg; if(e.type==='sysadmin' && Math.abs(b.vx)>Math.abs(b.vy)) dmg*=0.2; 
                    if(b.boom){
                        Game.enemies.forEach(s=>{if(Math.hypot(s.x-b.x,s.y-b.y)<100)s.hp-=b.dmg;});
                        for(let k=0;k<8;k++)Game.decals.push({x:b.x,y:b.y,r:Math.random()*5,c:'#f50',v:true,life:30});
                        b.life=0; MusicSys.hit();
                    } else {
                        e.hp-=dmg; e.push.x=b.vx*0.5;e.push.y=b.vy*0.5; if(!b.pierce) b.life=0; MusicSys.hit();
                        Game.decals.push({x:e.x+(Math.random()-0.5)*10, y:e.y+(Math.random()-0.5)*10, r:Math.random()*4+2, c:'#800', life: 999});
                    }
                    if(e.hp<=0 && !e.dead){
                        e.dead=true; Game.score++; Save.data.stats.kills++; Game.addCombo();
                        if(e.type==='ceo') Save.data.stats.bossKills++;
                        
                        // FIX: ADD ULT CHARGE
                        Game.player.ult = Math.min(Game.player.maxUlt, Game.player.ult+5);
                        
                        const qList = QUIPS_DB[e.type];
                        if(Math.random()<0.3 && qList) Game.say(qList[Math.floor(Math.random()*qList.length)], e);
                        if(Math.random()<0.1) Game.say(QUIPS_DB.player_kill[Math.floor(Math.random()*QUIPS_DB.player_kill.length)], 'player');
                        if(e.type==='ceo') Game.say(QUIPS_DB.player_boss[0], 'player');

                        Game.decals.push({x:e.x,y:e.y,r:e.r,c:'#600', life:3600});
                        Game.pickups.push({x:e.x,y:e.y,t:'xp',v:e.xp, life:3600});
                        if(Math.random()<0.05) Game.pickups.push({x:e.x,y:e.y,t:'heal',v:20, life:3600});
                        if(Math.random()<0.05 || e.type==='ceo') Game.drops.push({x:e.x,y:e.y,w:WEAPONS[Math.floor(Math.random()*WEAPONS.length)],l:600});
                    }
                }
            });
        });

        Game.bullets.forEach(b=>{
            if(b.enemy && Math.hypot(b.x-Game.player.x, b.y-Game.player.y)<20) { Game.player.hp-=b.dmg; b.life=0; Game.cam.shake=10; if(Game.player.hp<=0)Game.over(); }
        });
        
        Game.enemies=Game.enemies.filter(e=>!e.dead);
        Game.bullets=Game.bullets.filter(b=>{b.x+=b.vx*Game.timeScale;b.y+=b.vy*Game.timeScale;b.life--;return b.life>0;});
        
        Game.pickups=Game.pickups.filter(p=>{ if(p.life) p.life--; if(p.life<=0) return false;
            const d=Math.hypot(Game.player.x-p.x,Game.player.y-p.y);
            if(d<150+Game.player.bon.mag*50){p.x+=(Game.player.x-p.x)*0.15;p.y+=(Game.player.y-p.y)*0.15;}
            if(d<40){
                if(p.t==='xp'){
                    MusicSys.pickup(); Game.player.xp+=p.v;
                    if(Game.player.xp>=Game.player.maxXp){Game.player.xp=0;Game.player.maxXp=Math.floor(Game.player.maxXp*1.5);Game.player.lvl++;MusicSys.lvlup();Game.pause();}
                } else if(p.t==='heal'){
                    if(Game.player.hp>=Game.player.maxHp) return true;
                    MusicSys.heal(); Game.player.hp=Math.min(Game.player.maxHp, Game.player.hp+p.v); Game.spawnText(Game.player.x, Game.player.y-50, "–õ–ï–ß–ï–ù–ò–ï!", "#0f0");
                }
                return false;
            } return true;
        });

        Game.drops=Game.drops.filter(d=>{d.l--; if(Math.hypot(Game.player.x-d.x,Game.player.y-d.y)<40){ 
            MusicSys.pickup(); Game.player.wep=d.w; Game.player.wepT=600; 
            Game.say(QUIPS_DB.player_wep[Math.floor(Math.random()*QUIPS_DB.player_wep.length)], 'player');
            return false; 
        } return d.l>0;});
        Game.texts=Game.texts.filter(t=>{t.y+=t.vy;t.life--;return t.life>0;});
        Game.decals=Game.decals.filter(d=>{ if(d.life) d.life--; return d.life>0 || d.life===undefined; });
        if(Game.decals.length > 300) Game.decals.shift();
        
        Game.cam.shake*=0.9; Game.cam.zoom += (0.3 - Game.cam.zoom)*0.1;
    }

    // DRAW
    ctx.fillStyle='#050505';ctx.fillRect(0,0,W,H); ctx.save();
    const cx = Game.cam.x-(Math.random()-0.5)*Game.cam.shake, cy = Game.cam.y-(Math.random()-0.5)*Game.cam.shake;
    ctx.translate(W/2, H/2); ctx.scale(Game.cam.zoom, Game.cam.zoom); ctx.translate(-W/2, -H/2); ctx.translate(-cx, -cy);
    
    ctx.lineWidth=2;ctx.strokeStyle='#1a1a1a'; ctx.beginPath();
    const gs=100, sx=Math.floor(cx/gs)*gs, ex=sx+W+gs, sy=Math.floor(cy/gs)*gs, ey=sy+H+gs;
    for(let x=sx;x<ex;x+=gs){ctx.moveTo(x,sy);ctx.lineTo(x,ey);} for(let y=sy;y<ey;y+=gs){ctx.moveTo(sx,y);ctx.lineTo(ex,y);} ctx.stroke();
    
    Game.decals.forEach(d=>{ if(d.v) { ctx.fillStyle=d.c;ctx.globalAlpha=d.life/30;ctx.fillRect(d.x,d.y,d.r,d.r); } else { ctx.fillStyle=d.c;ctx.globalAlpha=0.7;ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,7);ctx.fill(); } }); ctx.globalAlpha=1;
    Game.pickups.forEach(p=>{ if(p.t==='heal') { ctx.fillStyle='#fff';ctx.fillRect(p.x-10,p.y-3,20,6);ctx.fillRect(p.x-3,p.y-10,6,20);ctx.fillStyle='#0f0';ctx.fillRect(p.x-8,p.y-2,16,4);ctx.fillRect(p.x-2,p.y-8,4,16); } else { ctx.fillStyle='#0f0';ctx.shadowBlur=10;ctx.shadowColor='#0f0';ctx.beginPath();ctx.arc(p.x,p.y,8,0,7);ctx.fill();ctx.shadowBlur=0; } });
    Game.drops.forEach(d=>{ctx.fillStyle=d.w.c;ctx.fillRect(d.x-10,d.y-10,20,20);ctx.fillStyle='#fff';ctx.fillText('?',d.x-3,d.y+5);});
    Game.enemies.forEach(e => e.draw(ctx));

    if(Game.player){
        const p=Game.player; const w=Math.sin(p.anim)*5;
        ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.angle);
        ctx.fillStyle='#cd853f';ctx.beginPath();ctx.ellipse(0,0,18,14,0,0,7);ctx.fill();
        ctx.fillStyle='#f04';ctx.shadowBlur=15;ctx.shadowColor='#f04';ctx.fillRect(-8,-12,12,24);ctx.shadowBlur=0; 
        ctx.strokeStyle='#f04';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(-5,-10);ctx.lineTo(-30,-20+w);ctx.stroke();ctx.beginPath();ctx.moveTo(-5,10);ctx.lineTo(-30,20+w);ctx.stroke();
        ctx.save();ctx.rotate(Math.sin(Game.frame*0.1)*0.3);ctx.fillStyle='#d2691e';ctx.beginPath();ctx.ellipse(-25,0,22,12,0,0,7);ctx.fill();ctx.restore(); 
        ctx.fillStyle='#333';ctx.fillRect(5,2,28,10); ctx.fillStyle=p.wep.c;ctx.fillRect(10,4,p.wepT>0?20:5,6); 
        if(Game.frame-p.lastShot<3){ctx.fillStyle='#ff0';ctx.shadowBlur=20;ctx.shadowColor='#ff0';ctx.beginPath();ctx.arc(38,7,12,0,7);ctx.fill();ctx.shadowBlur=0;} 
        ctx.restore();
    }

    ctx.globalCompositeOperation = 'lighter';
    Game.bullets.forEach(b=>{ ctx.fillStyle=b.c; ctx.shadowBlur=b.name==='–ö–û–§–ï–ú–ï–¢'?15:5; ctx.shadowColor=b.c; ctx.beginPath(); ctx.arc(b.x,b.y,b.boom?6:4,0,7); ctx.fill(); });
    ctx.globalCompositeOperation = 'source-over'; ctx.shadowBlur=0;

    ctx.font="bold 20px Roboto";ctx.textAlign="center";
    Game.texts.forEach(t=>{ ctx.save(); ctx.translate(t.x, t.y); ctx.scale(t.scale||1, t.scale||1); ctx.fillStyle=t.col; ctx.shadowBlur=5; ctx.shadowColor='#000'; ctx.fillText(t.txt,0,0); ctx.restore(); });

    ctx.restore();
    if(Game.state!=='OVER')requestAnimationFrame(loop);
}

function generateCards(){
    const b=document.getElementById('cards-box');b.innerHTML='';
    [{n:"–ü–£–õ–ï–ú–ï–¢",i:"üî´",d:"–°–ö–û–†–û–°–¢–¨ +25%",f:()=>Game.player.bon.spd*=1.1},{n:"–î–†–û–ë–û–í–ò–ö",i:"üí•",d:"–ü–£–õ–ò +1",f:()=>Game.player.bon.mul++},{n:"–ú–ê–ì–ù–ò–¢",i:"üß≤",d:"–°–ë–û–† +50%",f:()=>Game.player.bon.mag++},{n:"–ë–û–ù–£–°",i:"üíé",d:"–£–†–û–ù +30%",f:()=>Game.player.bon.dmg*=1.3}]
    .sort(()=>Math.random()-0.5).slice(0,3).forEach(x=>{const d=document.createElement('div');d.className='card';d.innerHTML=`<div class="c-icon">${x.i}</div><div><div class="c-title">${x.n}</div><div class="c-desc">${x.d}</div></div>`;d.onclick=()=>{x.f();Game.resume();};b.appendChild(d);});
}

let touchStartX = 0, touchStartY = 0, touchMoving = false;
cvs.addEventListener('touchstart', (e) => { e.preventDefault(); const touch = e.touches[0]; const rect = cvs.getBoundingClientRect(); touchStartX = touch.clientX - rect.left; touchStartY = touch.clientY - rect.top; touchMoving = true; }, { passive: false });
cvs.addEventListener('touchmove', (e) => { e.preventDefault(); if (!touchMoving || Game.state !== 'PLAY') return; const touch = e.touches[0]; const rect = cvs.getBoundingClientRect(); const touchX = touch.clientX - rect.left; const touchY = touch.clientY - rect.top; const dx = touchX - touchStartX; const dy = touchY - touchStartY; Game.keys['KeyA'] = false; Game.keys['KeyD'] = false; Game.keys['KeyW'] = false; Game.keys['KeyS'] = false; if (dx < -5) Game.keys['KeyA'] = true; if (dx > 5) Game.keys['KeyD'] = true; if (dy < -5) Game.keys['KeyW'] = true; if (dy > 5) Game.keys['KeyS'] = true; }, { passive: false });
cvs.addEventListener('touchend', (e) => { e.preventDefault(); touchMoving = false; Game.keys['KeyA'] = false; Game.keys['KeyD'] = false; Game.keys['KeyW'] = false; Game.keys['KeyS'] = false; }, { passive: false });
document.addEventListener('touchstart', (e) => { if (Game.state !== 'PLAY') return; const rect = cvs.getBoundingClientRect(); const x = e.touches[0].clientX - rect.left; const y = e.touches[0].clientY - rect.top; if (y < H * 0.15) { Game.keys['ShiftLeft'] = true; setTimeout(() => Game.keys['ShiftLeft'] = false, 100); } }, { passive: false });

// Init
Save.load(); IntroSys.init();
window.onkeydown=e=>{if(e.code==='Space'&&IntroSys.active)IntroSys.skip(); Game.keys[e.code]=true;};
window.onkeyup=e=>Game.keys[e.code]=false;
window.onmousedown=e=>{if(e.button===2)Game.mouse.r=true;else Game.mouse.down=true;};
window.onmouseup=e=>{if(e.button===2)Game.mouse.r=false;else Game.mouse.down=false;};
window.onmousemove=e=>{Game.mouse.x=e.clientX;Game.mouse.y=e.clientY;};
</script>
</body>
</html>
